<!-- DirectMessageRoom -->
<!-- Chat room for 1 on 1 conversations -->
{% extends 'base.html' %}
{% load static %}
{% block content %}
<script src="{% static 'bootstrap/js/jquery-3.6.0.min.js' %}"></script>
<style type="text/css">
.chat-log {
    height: 500px;
    overflow-x: hidden;
    overflow-y: auto;
    padding: 10px;
    background-color: #fff;
    font-size: 0.9em;
    flex-direction: column-reverse;
}

.chat-message-input-container {
    outline: none;
    box-shadow: none;
}

.chat-message-input {
    outline: none;
    border: 1px solid #fff;
    border-top: 2px solid var(--main-background-color);

}

.message-container {
    margin-top: 10px;
    justify-content: start;
}

.username-span {
    font-weight: 600;
    margin-top: 0px;
    margin-bottom: auto;
    margin-left: 5px;
    margin-right: 5px;
}

.friend-message-span {
    font-weight: 380;
    margin-top: 0px;
    margin-bottom: auto;
    margin-left: 5px;
    margin-right: 5px;
    font-size: 0.6em;
    color: var(--light-primary-text-color);
}

.timestamp-span {
    font-weight: 400;
    font-size: 0.8em;
    color: var(--secondary-text-color);
}

.timestamp-span:hover {
    cursor: pointer;
}

.msg-p {
    font-weight: 450;
    margin-top: 5px;
    margin-bottom: auto;
    margin-left: 5px;
    margin-right: 5px;
    white-space: normal;
    -ms-word-break: break-all;
    word-break: break-all;
}

.profile-image {
    width: 33px;
    height: 33px;
    margin-top: 0px;
    margin-bottom: auto;
}

.profile-image-small {
    width: 25px;
    height: 25px;
    margin-top: 0px;
    margin-bottom: auto;
    margin-right: 5px;
}

.profile-image:hover {
    cursor: pointer;
}

.profile-image-small:hover {
    cursor: pointer;
}

.username-span:hover {
    cursor: pointer;
}

.material-icons:hover {
    cursor: pointer;
}

.card {
    border-radius: 12px;
}

#id_chatroom_loading_spinner {
    position: absolute;
}

.friend-container:hover {
    background: var(--main-background-color);
    cursor: pointer;
}

.friends-list-container {
    max-height: 500px;
    overflow-y: scroll;
}
</style>
<div class="container">
    <div class="row">
        <div class="col-sm-9 m-0 p-2">
            <div class="card" id="id_chatroom_card">
                <!-- card header -->
                <div class="d-flex flex-row align-items-center card-header" id="id_room_title">
                    <a class="d-flex flex-row" target="_blank" id="id_user_info_container">
                        <img class="profile-image rounded-circle img-fluid" id="id_other_user_profile_image" src="{{user.profile_image.url}}">
                        <h3 class="ml-2" id="id_other_username"></h3>
                    </a>
                </div>
                <!-- card body -->
                <div class="card-body p-1">
                    <div class="d-flex flex-column" id="id_chat_log_container">
                        <div class="d-flex flex-row justify-content-center" id="id_chatroom_loading_spinner_container">
                            <div class="spinner-border text-primary" id="id_chatroom_loading_spinner" role="status" style="display: none; ">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div class="d-flex chat-log" id="id_chat_log">
                        </div>
                        <span class="{% if not debug %}d-none{% endif %} page-number" id="id_page_number">1</span>
                        <div class="d-flex flex-row chat-message-input-container">
                            <textarea class="flex-grow-1 chat-message-input" id="id_chat_message_input" placeholder="Message..."></textarea>
                            <button class="btn btn-primary chat-message-submit-button">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
                <!-- card body end -->
            </div>
        </div>
        <div class="col-sm-3 m-0 p-2">
            <div class="card">
                <div class="d-flex flex-row align-items-center card-header">
                    <h3>Chats</h3>
                </div>
                <div class="card-body p-1">
                    <div class="d-flex flex-column friends-list-container ">
                        {% for x in m_and_r %}
                        <div class="d-flex flex-row p-2 friend-container flex-grow-1" onclick="onSelectRecipient('{{x.recipient.id}}')" id="id_recipient_container_{{x.recipient.id}}">
                            <img class="profile-image rounded-circle img-fluid" id="id_recipient_img_{{x.recipient.profile_image.url}}" src=" {{x.recipient.profile_image.url}}">
                            <div class="d-flex flex-column">
                                <span class="username-span">{{x.recipient.username}}</span>
                                <span class="friend-message-span">{{x.message|truncatechars:20}}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Client Error MODAL -->
<button type="button" id="id_trigger_client_error_modal" class="d-none btn btn-primary" data-toggle="modal" data-target="#id_client_error_modal">
</button>
<div class="modal fade" id="id_client_error_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Socket Client Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="id_client_error_modal_body">Something went wrong.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="id_client_error_modal_close_btn">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Client Error MODAL -->
<script type="text/javascript">
var chatSocket = null;
var roomId = null;

onStart()

function onStart() { 
    {% if m_and_r %}
    onSelectRecipient("{{m_and_r.0.recipient.id}}") 
    {% endif %}

    {% for x in m_and_r %}
    preloadImage("{{x.recipient.profile_image.url|safe}}", "id_recipient_img_{{x.recipient.id}}") 
    {% endfor %}
}

function onSelectRecipient(userId){
    createOrReturnPrivateChat(userId)
}

function closeWebSocket() {
    if (chatSocket != null) {
        chatSocket.close()
        chatSocket = null
    }
}

function setupWebSocket(room_id) {

    console.log("setupWebSocket: " + room_id)

    roomId = room_id

    // close previous socket if one is open
    closeWebSocket()

    // Correctly decide between ws:// and wss://
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws"; {% if debug_mode %}
    var ws_path = ws_scheme + '://' + window.location.host + "/directmessage/" + roomId + "/"; // development
    {% else %}
    var ws_path = ws_scheme + '://' + window.location.host + ":8001/directmessage/" + roomId + "/"; // production
    {% endif %}


    // console.log("Connecting to " + ws_path);
    chatSocket = new WebSocket(ws_path);

    // Handle incoming messages
    chatSocket.onmessage = function(message) {
        // Decode the JSON
        // console.log("Got chat websocket message " + message.data);
        console.log("Got websocket message.");
        var data = JSON.parse(message.data);

        // display the progress bar?
        displayChatroomLoadingSpinner(data.display_progress_bar)

        // Handle errors (ClientError)
        if (data.error) {
            console.error(data.error + ": " + data.message)
            return;
        }
        // Handle joining (Client perspective)
        if (data.join) {
            console.log("Joining room " + data.join);
        }
        // Handle leaving (client perspective)
        if (data.leave) {
            // do nothing
            console.log("Leaving room " + data.leave);
        }
    };

    chatSocket.addEventListener("open", function(e) {
        console.log("ChatSocket OPEN")
        // join chat room
        if ("{{request.user.is_authenticated}}") {
            chatSocket.send(JSON.stringify({
                "command": "join",
                "room": roomId
            }));
        }
    })

    chatSocket.onclose = function(e) {
        console.log('Chat socket closed.');
    };

    chatSocket.onOpen = function(e) {
        console.log("ChatSocket onOpen", e)
    }

    chatSocket.onerror = function(e) {
        console.log('ChatSocket error', e)
    }

    if (chatSocket.readyState == WebSocket.OPEN) {
        console.log("ChatSocket OPEN")
    } else if (chatSocket.readyState == WebSocket.CONNECTING) {
        console.log("ChatSocket connecting..")
    }
}

function createOrReturnPrivateChat(id) {
    payload = {
        "csrfmiddlewaretoken": "{{ csrf_token }}",
        "user2_id": id,
    }
    $.ajax({
        type: 'POST',
        dataType: "json",
        url: "{% url 'directmessage:create-or-return-private-chat' %}", // production
        data: payload,
        timeout: 5000,
        success: function(data) {
            console.log("SUCCESS", data)
            if (data['response'] == "Successfully got the chat.") {
                setupWebSocket(data['chatroom_id'])
            } else if (data['response'] != null) {
                alert(data['response'])
            }
        },
        error: function(data) {
            console.error("ERROR...", data)
            alert("Something went wrong.")
        },
    });
}
</script>
{% endblock content %}